extern "C" void pit_handler(void);
extern "C" void keyboard_handler(void);

extern "C" void handler_0(void);
extern "C" void handler_1(void);
extern "C" void handler_2(void);
extern "C" void handler_3(void);
extern "C" void handler_4(void);
extern "C" void handler_5(void);
extern "C" void handler_6(void);
extern "C" void handler_7(void);
extern "C" void handler_8(void);
extern "C" void handler_9(void);
extern "C" void handler_10(void);
extern "C" void handler_11(void);
extern "C" void handler_12(void);
extern "C" void handler_13(void);
extern "C" void handler_14(void);
extern "C" void handler_15(void);
extern "C" void handler_16(void);
extern "C" void handler_17(void);
extern "C" void handler_18(void);
extern "C" void handler_19(void);
extern "C" void handler_20(void);
extern "C" void handler_21(void);
extern "C" void handler_22(void);
extern "C" void handler_23(void);
extern "C" void handler_24(void);
extern "C" void handler_25(void);
extern "C" void handler_26(void);
extern "C" void handler_27(void);
extern "C" void handler_28(void);
extern "C" void handler_29(void);
extern "C" void handler_30(void);
extern "C" void handler_31(void);
extern "C" void handler_32(void);
extern "C" void handler_33(void); // Replaced with pit_handler
extern "C" void handler_34(void);
extern "C" void handler_35(void);
extern "C" void handler_36(void);
extern "C" void handler_37(void);
extern "C" void handler_38(void);
extern "C" void handler_39(void);
extern "C" void handler_40(void);
extern "C" void handler_41(void);
extern "C" void handler_42(void);
extern "C" void handler_43(void);
extern "C" void handler_44(void);
extern "C" void handler_45(void);
extern "C" void handler_46(void);
extern "C" void handler_47(void);
extern "C" void handler_48(void);
extern "C" void handler_49(void);
extern "C" void handler_50(void);
extern "C" void handler_51(void);
extern "C" void handler_52(void);
extern "C" void handler_53(void);
extern "C" void handler_54(void);
extern "C" void handler_55(void);
extern "C" void handler_56(void);
extern "C" void handler_57(void);
extern "C" void handler_58(void);
extern "C" void handler_59(void);
extern "C" void handler_60(void);
extern "C" void handler_61(void);
extern "C" void handler_62(void);
extern "C" void handler_63(void);
extern "C" void handler_64(void);
extern "C" void handler_65(void);
extern "C" void handler_66(void);
extern "C" void handler_67(void);
extern "C" void handler_68(void);
extern "C" void handler_69(void);
extern "C" void handler_70(void);
extern "C" void handler_71(void);
extern "C" void handler_72(void);
extern "C" void handler_73(void);
extern "C" void handler_74(void);
extern "C" void handler_75(void);
extern "C" void handler_76(void);
extern "C" void handler_77(void);
extern "C" void handler_78(void);
extern "C" void handler_79(void);
extern "C" void handler_80(void);
extern "C" void handler_81(void);
extern "C" void handler_82(void);
extern "C" void handler_83(void);
extern "C" void handler_84(void);
extern "C" void handler_85(void);
extern "C" void handler_86(void);
extern "C" void handler_87(void);
extern "C" void handler_88(void);
extern "C" void handler_89(void);
extern "C" void handler_90(void);
extern "C" void handler_91(void);
extern "C" void handler_92(void);
extern "C" void handler_93(void);
extern "C" void handler_94(void);
extern "C" void handler_95(void);
extern "C" void handler_96(void);
extern "C" void handler_97(void);
extern "C" void handler_98(void);
extern "C" void handler_99(void);
extern "C" void handler_100(void);
extern "C" void handler_101(void);
extern "C" void handler_102(void);
extern "C" void handler_103(void);
extern "C" void handler_104(void);
extern "C" void handler_105(void);
extern "C" void handler_106(void);
extern "C" void handler_107(void);
extern "C" void handler_108(void);
extern "C" void handler_109(void);
extern "C" void handler_110(void);
extern "C" void handler_111(void);
extern "C" void handler_112(void);
extern "C" void handler_113(void);
extern "C" void handler_114(void);
extern "C" void handler_115(void);
extern "C" void handler_116(void);
extern "C" void handler_117(void);
extern "C" void handler_118(void);
extern "C" void handler_119(void);
extern "C" void handler_120(void);
extern "C" void handler_121(void);
extern "C" void handler_122(void);
extern "C" void handler_123(void);
extern "C" void handler_124(void);
extern "C" void handler_125(void);
extern "C" void handler_126(void);
extern "C" void handler_127(void);
extern "C" void handler_128(void);
extern "C" void handler_129(void);
extern "C" void handler_130(void);
extern "C" void handler_131(void);
extern "C" void handler_132(void);
extern "C" void handler_133(void);
extern "C" void handler_134(void);
extern "C" void handler_135(void);
extern "C" void handler_136(void);
extern "C" void handler_137(void);
extern "C" void handler_138(void);
extern "C" void handler_139(void);
extern "C" void handler_140(void);
extern "C" void handler_141(void);
extern "C" void handler_142(void);
extern "C" void handler_143(void);
extern "C" void handler_144(void);
extern "C" void handler_145(void);
extern "C" void handler_146(void);
extern "C" void handler_147(void);
extern "C" void handler_148(void);
extern "C" void handler_149(void);
extern "C" void handler_150(void);
extern "C" void handler_151(void);
extern "C" void handler_152(void);
extern "C" void handler_153(void);
extern "C" void handler_154(void);
extern "C" void handler_155(void);
extern "C" void handler_156(void);
extern "C" void handler_157(void);
extern "C" void handler_158(void);
extern "C" void handler_159(void);
extern "C" void handler_160(void);
extern "C" void handler_161(void);
extern "C" void handler_162(void);
extern "C" void handler_163(void);
extern "C" void handler_164(void);
extern "C" void handler_165(void);
extern "C" void handler_166(void);
extern "C" void handler_167(void);
extern "C" void handler_168(void);
extern "C" void handler_169(void);
extern "C" void handler_170(void);
extern "C" void handler_171(void);
extern "C" void handler_172(void);
extern "C" void handler_173(void);
extern "C" void handler_174(void);
extern "C" void handler_175(void);
extern "C" void handler_176(void);
extern "C" void handler_177(void);
extern "C" void handler_178(void);
extern "C" void handler_179(void);
extern "C" void handler_180(void);
extern "C" void handler_181(void);
extern "C" void handler_182(void);
extern "C" void handler_183(void);
extern "C" void handler_184(void);
extern "C" void handler_185(void);
extern "C" void handler_186(void);
extern "C" void handler_187(void);
extern "C" void handler_188(void);
extern "C" void handler_189(void);
extern "C" void handler_190(void);
extern "C" void handler_191(void);
extern "C" void handler_192(void);
extern "C" void handler_193(void);
extern "C" void handler_194(void);
extern "C" void handler_195(void);
extern "C" void handler_196(void);
extern "C" void handler_197(void);
extern "C" void handler_198(void);
extern "C" void handler_199(void);
extern "C" void handler_200(void);
extern "C" void handler_201(void);
extern "C" void handler_202(void);
extern "C" void handler_203(void);
extern "C" void handler_204(void);
extern "C" void handler_205(void);
extern "C" void handler_206(void);
extern "C" void handler_207(void);
extern "C" void handler_208(void);
extern "C" void handler_209(void);
extern "C" void handler_210(void);
extern "C" void handler_211(void);
extern "C" void handler_212(void);
extern "C" void handler_213(void);
extern "C" void handler_214(void);
extern "C" void handler_215(void);
extern "C" void handler_216(void);
extern "C" void handler_217(void);
extern "C" void handler_218(void);
extern "C" void handler_219(void);
extern "C" void handler_220(void);
extern "C" void handler_221(void);
extern "C" void handler_222(void);
extern "C" void handler_223(void);
extern "C" void handler_224(void);
extern "C" void handler_225(void);
extern "C" void handler_226(void);
extern "C" void handler_227(void);
extern "C" void handler_228(void);
extern "C" void handler_229(void);
extern "C" void handler_230(void);
extern "C" void handler_231(void);
extern "C" void handler_232(void);
extern "C" void handler_233(void);
extern "C" void handler_234(void);
extern "C" void handler_235(void);
extern "C" void handler_236(void);
extern "C" void handler_237(void);
extern "C" void handler_238(void);
extern "C" void handler_239(void);
extern "C" void handler_240(void);
extern "C" void handler_241(void);
extern "C" void handler_242(void);
extern "C" void handler_243(void);
extern "C" void handler_244(void);
extern "C" void handler_245(void);
extern "C" void handler_246(void);
extern "C" void handler_247(void);
extern "C" void handler_248(void);
extern "C" void handler_249(void);
extern "C" void handler_250(void);
extern "C" void handler_251(void);
extern "C" void handler_252(void);
extern "C" void handler_253(void);
extern "C" void handler_254(void);
extern "C" void handler_255(void);

static void (*handlers[256])(void) = {
    handler_0,
    handler_1,
    handler_2,
    handler_3,
    handler_4,
    handler_5,
    handler_6,
    handler_7,
    handler_8,
    handler_9,
    handler_10,
    handler_11,
    handler_12,
    handler_13,
    handler_14,
    handler_15,
    handler_16,
    handler_17,
    handler_18,
    handler_19,
    handler_20,
    handler_21,
    handler_22,
    handler_23,
    handler_24,
    handler_25,
    handler_26,
    handler_27,
    handler_28,
    handler_29,
    handler_30,
    handler_31,
    handler_32, // Replaced with pit_handler
    handler_33, // Replaced with keyboard_handler
    handler_34,
    handler_35,
    handler_36,
    handler_37,
    handler_38,
    handler_39,
    handler_40,
    handler_41,
    handler_42,
    handler_43,
    handler_44,
    handler_45,
    handler_46,
    handler_47,
    handler_48,
    handler_49,
    handler_50,
    handler_51,
    handler_52,
    handler_53,
    handler_54,
    handler_55,
    handler_56,
    handler_57,
    handler_58,
    handler_59,
    handler_60,
    handler_61,
    handler_62,
    handler_63,
    handler_64,
    handler_65,
    handler_66,
    handler_67,
    handler_68,
    handler_69,
    handler_70,
    handler_71,
    handler_72,
    handler_73,
    handler_74,
    handler_75,
    handler_76,
    handler_77,
    handler_78,
    handler_79,
    handler_80,
    handler_81,
    handler_82,
    handler_83,
    handler_84,
    handler_85,
    handler_86,
    handler_87,
    handler_88,
    handler_89,
    handler_90,
    handler_91,
    handler_92,
    handler_93,
    handler_94,
    handler_95,
    handler_96,
    handler_97,
    handler_98,
    handler_99,
    handler_100,
    handler_101,
    handler_102,
    handler_103,
    handler_104,
    handler_105,
    handler_106,
    handler_107,
    handler_108,
    handler_109,
    handler_110,
    handler_111,
    handler_112,
    handler_113,
    handler_114,
    handler_115,
    handler_116,
    handler_117,
    handler_118,
    handler_119,
    handler_120,
    handler_121,
    handler_122,
    handler_123,
    handler_124,
    handler_125,
    handler_126,
    handler_127,
    handler_128,
    handler_129,
    handler_130,
    handler_131,
    handler_132,
    handler_133,
    handler_134,
    handler_135,
    handler_136,
    handler_137,
    handler_138,
    handler_139,
    handler_140,
    handler_141,
    handler_142,
    handler_143,
    handler_144,
    handler_145,
    handler_146,
    handler_147,
    handler_148,
    handler_149,
    handler_150,
    handler_151,
    handler_152,
    handler_153,
    handler_154,
    handler_155,
    handler_156,
    handler_157,
    handler_158,
    handler_159,
    handler_160,
    handler_161,
    handler_162,
    handler_163,
    handler_164,
    handler_165,
    handler_166,
    handler_167,
    handler_168,
    handler_169,
    handler_170,
    handler_171,
    handler_172,
    handler_173,
    handler_174,
    handler_175,
    handler_176,
    handler_177,
    handler_178,
    handler_179,
    handler_180,
    handler_181,
    handler_182,
    handler_183,
    handler_184,
    handler_185,
    handler_186,
    handler_187,
    handler_188,
    handler_189,
    handler_190,
    handler_191,
    handler_192,
    handler_193,
    handler_194,
    handler_195,
    handler_196,
    handler_197,
    handler_198,
    handler_199,
    handler_200,
    handler_201,
    handler_202,
    handler_203,
    handler_204,
    handler_205,
    handler_206,
    handler_207,
    handler_208,
    handler_209,
    handler_210,
    handler_211,
    handler_212,
    handler_213,
    handler_214,
    handler_215,
    handler_216,
    handler_217,
    handler_218,
    handler_219,
    handler_220,
    handler_221,
    handler_222,
    handler_223,
    handler_224,
    handler_225,
    handler_226,
    handler_227,
    handler_228,
    handler_229,
    handler_230,
    handler_231,
    handler_232,
    handler_233,
    handler_234,
    handler_235,
    handler_236,
    handler_237,
    handler_238,
    handler_239,
    handler_240,
    handler_241,
    handler_242,
    handler_243,
    handler_244,
    handler_245,
    handler_246,
    handler_247,
    handler_248,
    handler_249,
    handler_250,
    handler_251,
    handler_252,
    handler_253,
    handler_254,
    handler_255,
};

constexpr u8 IDT_TASK_GATE = 0x5;
constexpr u8 IDT_INTERRUPT_GATE_16 = 0x6;
constexpr u8 IDT_TRAP_GATE_16 = 0x7;
constexpr u8 IDT_INTERRUPT_GATE_32 = 0xe;
constexpr u8 IDT_TRAP_GATE_32 = 0xf;

struct __attribute__((packed)) Idt_Entry {
    u16 offset_low;
    u16 selector;
    u8 reserved;
    u8 flags;
    u16 offset_high;
};

struct __attribute__((packed)) Idtr {
    u16 size;
    u32 offset;
};

static volatile Idt_Entry* idt = (Idt_Entry*)0x4000;
static volatile Idtr* idtr = (Idtr*)0x6000;

void init_idt(void) {
    for (int i = 0; i < 32; ++i) {
        idt[i].offset_low = (u32)handlers[i] & 0xffff;
        idt[i].selector = 0x8;
        idt[i].reserved = 0;
        idt[i].flags = (1 << 7) | IDT_TRAP_GATE_32;
        idt[i].offset_high = (u32)handlers[i] >> 16;
    }

    for (int i = 32; i < 256; ++i) {
        idt[i].offset_low = (u32)handlers[i] & 0xffff;
        idt[i].selector = 0x8;
        idt[i].reserved = 0;
        idt[i].flags = (1 << 7) | IDT_INTERRUPT_GATE_32;
        idt[i].offset_high = (u32)handlers[i] >> 16;
    }

    idt[32].offset_low = (u32)pit_handler & 0xffff;
    idt[32].selector = 0x08;
    idt[32].reserved = 0;
    idt[32].flags = (1 << 7) | IDT_TRAP_GATE_32;
    idt[32].offset_high = (u32)pit_handler >> 16;

    idt[33].offset_low = (u32)keyboard_handler & 0xffff;
    idt[33].selector = 0x08;
    idt[33].reserved = 0;
    idt[33].flags = (1 << 7) | IDT_TRAP_GATE_32;
    idt[33].offset_high = (u32)keyboard_handler >> 16;

    idtr->size = 8 * 256 - 1;
    idtr->offset = (u32)idt;
}
